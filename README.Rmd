---
title: "Major-Minor and Consonance-Dissonance Perception"
output:
  github_document: default
---

```{r, echo=F, message=F, include=F}
devtools::load_all(".")
source('./man/code/plot.R')
source('./man/code/utils.R')
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-"
)
BEHAVIOURAL_SMOOTH_BROAD  <- 0.2
BEHAVIOURAL_SMOOTH_NARROW <- 0.035
```

## Timbre: Consonance-Dissonance and Major-Minor ~ Semitones

This section is based on [Timbral effects on consonance disentangle psychoacoustic mechanisms and suggest perceptual origins for musical scales](https://www.nature.com/articles/s41467-024-45812-z) by Raja Marjieh, Peter M. C. Harrison, Harin Lee, Fotini Deligiannaki & Nori Jacoby.

#### Notes on Plots:

In the plots below:

* The cream lines are smoothed experimental data from Marjieh, Harrison et al.

* The multi-colored points are MaMi.CoDi computational predictions

* The multi-colored lines are smoothed MaMi.CoDi computational predictions

* The colors represent MaMi.CoDi computational predictions for major-minor polarity:
    * Gold is major
    * Red is neutral
    * Blue is minor

* The vertical axis is z-scored consonance-dissonance

* The horizontal axis is the width of the dyad that was judged from 0 to 15 semitones.
    * For example, the data at 4 represents the equal tempered major third, M3.
    * While the data at 8 represents the equal tempered minor sixth, m6.
    

#### Notes on Dyads:

* The dyads immediately below, from the timbre study, are true two-pitch dyads. True 
major thirds like C4 and E4, for example, only includes C4 and E4.

* The intervals in the last few sections, further below, are actually three-pitch 
chords with the high and low pitches one octave apart framing the interval, for 
example: C4, E4 and C5.

* True two-pitch dyads versus octave-framed, three-pitch chords, might show
different major-minor polarities.

* Consider two chords containing C4 and E4: 
    * C4, E4, C5 (a framed major third) is predicted to sound major and 
    * E3, C4, E4 (a framed minor sixth) is predicted to sound minor.


## Frequencies

```{r, include=F}
timbre_paper = readRDS('./man/data/timbre_paper.rds')
```

```{r, include=F}
dyads <- timbre_paper %>% dplyr::rowwise() %>% dplyr::mutate(
  type          = metadata$type,
  num_harmonics = metadata$num_harmonics,
  octave_ratio  = metadata$octave_ratio,
  semitone      = metadata$semitone,
  scale         = metadata$scale,
  label         = round(metadata$semitone),
  chord_max     = max(frequencies),
  chord_min     = min(frequencies),
  .before=1
)
```

```{r, fig.height=8, fig.width=12, echo=F, results='asis', message=F}
params = list(
  list(h=10,o=2.1,s='macro'),
  list(h=10,o=2.0,s='macro'),
  list(h=10,o=1.9,s='macro'),
  list(h=4,o=2,s='Bonang'),
  list(h=1, o=2.0,s='macro'),
  list(h=5, o=2.0,s='macro'),
  list(h=5,o=2,s='5PartialsNo3'),
  list(h=10,o=2.0,s='P8'),
  list(h=10,o=2.0,s='M6'),
  list(h=10,o=2.0,s='M3')
)

params %>% purrr::map(\(p) {
  gray_vlines = c()
  black_vlines = c()
  if (p$o<2 & p$s == 'macro') {
    timbre = 'Compressed'
    black_vlines  = c(11.10)
  } else if (p$o>2 & p$s == 'macro') {
    timbre = 'Stretched'
    black_vlines  = c(12.78)
  } else if (p$o==2 & p$h==1 & p$s == 'macro') {
    timbre = 'Pure'
    black_vlines = c()
  } else if (p$s == 'Bonang') {
    timbre = 'Bonang'
    black_vlines = c(2.60, 4.80, 11.98)
    gray_vlines  = c(7.2, 9.6)
  } else if (p$o==2 & p$h==5 & p$s == '5PartialsNo3') {
    timbre = '5PartialsNo3'
    black_vlines = c()
  } else if (p$o==2 & p$h==5 & p$s == 'macro') {
    timbre = '5Partials'
    black_vlines = c()
  } else if (p$o==2 & p$h==10 & p$s == 'macro') {
    timbre = 'Harmonic'
    black_vlines  = c(12.04)
  } else if (p$s == 'M3') {
    timbre = 'M3'
    gray_vlines = c(hrep::freq_to_midi(hrep::midi_to_freq(60) * 5/4)-60,4)
    black_vlines  = c(3.95)
  } else if (p$s == 'M6') {
    timbre = 'M6'
    gray_vlines = c(hrep::freq_to_midi(hrep::midi_to_freq(60) * 5/3)-60,9)
    black_vlines  = c(8.78,8.93)
  } else if (p$s == 'P8') {
    timbre = 'P8'
    gray_vlines = c(hrep::freq_to_midi(hrep::midi_to_freq(60) * 2/1)-60)
    black_vlines  = c(11.94, 12.08)
  }
  title = paste(
    timbre,
    '~',
    'Partials:', p$h
  )
  
  chords <- dyads %>% dplyr::filter(num_harmonics  == p$h &
                                      octave_ratio == p$o &
                                      scale        == p$s)
  chords$consonance_dissonance_z = z_scores(chords$consonance_dissonance)
  
  experiment.rds = paste0('./man/data/',
                          timbre,
                          '.rds')
  
  experiment = readRDS(experiment.rds)$profile %>%
    dplyr::rename(semitone=interval)
  
  experiment <- experiment %>% dplyr::mutate(
    consonance_dissonance = rating,
    consonance_dissonance_2x = 2*rating,
    consonance_dissonance_4x = 4*rating
  )
  if (p$s == 'macro' | p$s == 'Bonang' | p$s == '5PartialsNo3') {
    sigma = BEHAVIOURAL_SMOOTH_BROAD
  } else {
    sigma = BEHAVIOURAL_SMOOTH_NARROW
  }
  cat("  \n###", title, '\n')
  print(knitr::kable(tibble::tibble_row(
    pseudo_octave       = paste(round(chords$pseudo_octave %>% unique, 2),
                                collapse = ' ')
  )))
  print(plot_semitone_codi(chords, paste('Consonance-Dissonance'),
                           goal=experiment,sigma=sigma,
                           black_vlines=black_vlines,gray_vlines=gray_vlines))
  cat("  \n")
})
```

## Amplitudes

```{r, include=F}
timbre_paper = readRDS('./man/data/roll_off_timbre_paper.rds')
```

```{r, include=F}
dyads <- timbre_paper %>% dplyr::rowwise() %>% dplyr::mutate(
  type          = metadata$type,
  num_harmonics = metadata$num_harmonics,
  octave_ratio  = metadata$octave_ratio,
  semitone      = metadata$semitone,
  roll_off      = metadata$roll_off,
  label         = round(metadata$semitone),
  chord_max     = max(frequencies),
  chord_min     = min(frequencies),
  .before=1
)
```

```{r, include=F}
params = list(
  list(h=10,r=2),
  list(h=10,r=7),
  list(h=10,r=12)
)
```

```{r, fig.height=8, fig.width=12, echo=F, results='asis', message=F}
params %>% purrr::map(\(p) {
  gray_vlines = c()
  black_vlines = c()
  title = paste(
    'Harmonic ~',
    'Roll Off:', p$r
  )
  
  chords <- dyads %>% dplyr::filter(roll_off == p$r)
  chords$consonance_dissonance_z = z_scores(chords$consonance_dissonance)
  
  experiment.csv = paste0('./man/data/',
                          'roll_off_', p$r,
                          '.csv')
  
  experiment = read.csv(experiment.csv) %>%
    dplyr::rename(semitone=interval)
  
  experiment <- experiment %>% dplyr::mutate(
    consonance_dissonance = rating,
    consonance_dissonance_2x = 2*rating,
    consonance_dissonance_4x = 4*rating
  )
  sigma = BEHAVIOURAL_SMOOTH_BROAD
  cat("  \n###", title, '\n')
  print(plot_semitone_codi(chords, paste('Consonance-Dissonance'),
                           goal=experiment,sigma=sigma,
                           black_vlines=black_vlines,gray_vlines=gray_vlines))
  cat("  \n")
})
```

# MaMi CoDi Plots

The dyads below are framed between the tonic and octave. A major third
like C4 and E4, for example, actually includes C4, E4 and C5.

```{r, include=F}
chord_types <- c('Dyads','Triads','Scales', 'Major Triad Progressions',
                 'Minor Triad Progressions')
chords <- chords %>% dplyr::filter(type %in% chord_types)

major_I = chords %>% dplyr::filter(type == 'Major Triad Progressions' &
                                     label == 'I')
minor_i = chords %>% dplyr::filter(type == 'Minor Triad Progressions' &
                                     label == 'i')

progression_tonics = list(
  'Major Triad Progressions 1' = (major_I$pitches[[1]] %>%
                                    mami.codi.R::mami.codi(num_harmonics=1))$frequencies[[1]],
  'Minor Triad Progressions 1' = (minor_i$pitches[[1]] %>% 
                                    mami.codi.R::mami.codi(num_harmonics=1))$frequencies[[1]],
  'Major Triad Progressions 5' = (major_I$pitches[[1]] %>%
                                    mami.codi.R::mami.codi(num_harmonics=5))$frequencies[[1]],
  'Minor Triad Progressions 5' = (minor_i$pitches[[1]] %>% 
                                    mami.codi.R::mami.codi(num_harmonics=5))$frequencies[[1]],
  'Major Triad Progressions 10' = (major_I$pitches[[1]] %>%
                                     mami.codi.R::mami.codi(num_harmonics=10))$frequencies[[1]],
  'Minor Triad Progressions 10' = (minor_i$pitches[[1]] %>% 
                                     mami.codi.R::mami.codi(num_harmonics=10))$frequencies[[1]]
)

```

```{r, include=F}
grid = tidyr::expand_grid(
  index         = seq_along(chords$pitches),
  num_harmonics = c(1,6,11)
)

results = grid %>% furrr::future_pmap_dfr(\(index,
                                            num_harmonics) {
  
  chord_spectrum = hrep::sparse_fr_spectrum(chords$pitches[[index]],
                                            num_harmonics = num_harmonics)
  
  if (endsWith(chords$type[index], 'Progressions')) {
    if (chords$label[index] == 'I' | chords$label[index] == 'i' | chords$label[index] == '') {
      tonic_spectrum = NULL
    } else {
      tonic_spectrum = progression_tonics[[paste(chords$type[index],num_harmonics)]]
    }
  } else {
    if (is.na(chords$tonic[[index]])) {
      tonic_spectrum = NULL
    } else {
      tonic_spectrum = hrep::sparse_fr_spectrum(chords$tonic[[index]],
                                                num_harmonics = num_harmonics)
    }
  }  
  mami.codi.R::mami.codi(chord_spectrum,
                         tonic=tonic_spectrum,
                         metadata=purrr::flatten(
                           list(chords$metadata[[index]],
                                num_harmonics=num_harmonics)
                         ),
                         verbose=T)
}, .progress=TRUE, .options = furrr::furrr_options(seed = T))

results <- results %>% dplyr::rowwise() %>% dplyr::mutate(
  label = metadata$label,
  type  = metadata$type, 
  num_harmonics=metadata$num_harmonics,
  .before=1
)
```

## Chords: Consonance-Dissonance ~ Major-Minor

```{r, echo=F, message=F, results='asis'}
for (t in chord_types) {
  
  cat("  \n###", t, '\n')
  
  for (n in results$num_harmonics %>% unique) {
    title = paste(
      t,
      '~',
      'Number of Harmonics:', n
    )
    r = results %>% dplyr::filter(
      type==t & 
        num_harmonics == n
    )
    print(plot_mami.codi(r, title, include_path=endsWith(t, 'Progressions'),
                         include_labels=T))
  }
  
  cat("  \n")
  
}
```
