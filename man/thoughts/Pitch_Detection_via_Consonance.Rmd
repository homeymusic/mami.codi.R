---
title: "Pitch Detection via Consonance"
output:
  github_document: default
always_allow_html: true
---
```{r, echo=F, message=F, include=F}
devtools::load_all(".")
source('./man/code/plot.R')
source('./man/code/utils.R')
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "../figures/PERIODS-"
)
knitr::opts_chunk$set(dev = 'svg')
```

### TODO: try a grid pausing combinations of hair cells at the same time

```{r, echo=F, message=F, include=F}
pause_frequency = function(spectrum, index) {
  spectrum$y[index] = 0
  spectrum
}
```

```{r, echo=F, message=F, include=F}
tonic_midi = 60
num_harmonics = 5
amount_of_noise = 2
num_tones= 3*amount_of_noise + num_harmonics
f0_frequency_scoreboard = rep(0,num_tones)
f1_frequency_scoreboard = rep(0,num_tones)
f2_frequency_scoreboard = rep(0,num_tones)
f3_frequency_scoreboard = rep(0,num_tones)
f4_frequency_scoreboard = rep(0,num_tones)
f0_period_scoreboard = rep(0,num_tones)
f1_period_scoreboard = rep(0,num_tones)
f2_period_scoreboard = rep(0,num_tones)
f3_period_scoreboard = rep(0,num_tones)
f4_period_scoreboard = rep(0,num_tones)
f0_spatiofrequency_scoreboard = rep(0,num_tones)
f1_spatiofrequency_scoreboard = rep(0,num_tones)
f2_spatiofrequency_scoreboard = rep(0,num_tones)
f3_spatiofrequency_scoreboard = rep(0,num_tones)
f4_spatiofrequency_scoreboard = rep(0,num_tones)
best_frequency=c(numeric())
best_period=c(numeric())
best_spatiofrequency=c(numeric())
chord = c(tonic_midi) %>% mami.codi(num_harmonics = num_harmonics, verbose = T)
chord_spectrum = chord$spectrum[[1]]
```

```{r, echo=F, message=F, include=F}
for (trial in 1:1000) {
  noise_spectrum = tibble::tibble(
    frequency = hrep::midi_to_freq(c(
      runif(n=amount_of_noise, min=0, max=60),
      runif(n=amount_of_noise, min=60, max=102),
      runif(n=amount_of_noise, min=102, max=127)
    )),
    amplitude = 1
  ) %>% as.list() %>%  hrep::sparse_fr_spectrum()
  
  noisy_chord_spectrum = do.call(
    hrep::combine_sparse_spectra,
    list(chord_spectrum, noise_spectrum)
  )
  
  noisy_chord = noisy_chord_spectrum %>% mami.codi(verbose = T)
  looped_paused = noisy_chord_spectrum$x %>% purrr::imap_dfr(\(frequency, index) {
    noisy_chord_spectrum %>%
      pause_frequency(index) %>%
      mami.codi(
        metadata = list(
          paused_frequency = frequency
        ),
        verbose=T
      )
  })
  
  frequency_scores = looped_paused %>% dplyr::rowwise() %>% dplyr::mutate(
    paused_frequency = metadata$paused_frequency,
    distance         = noisy_chord$frequency_consonance-frequency_consonance
  )
  
  frequency_results = frequency_scores %>%
    dplyr::arrange(
      dplyr::desc(distance),
      paused_frequency
    )  %>%
    dplyr::ungroup() %>% 
    dplyr::mutate(
      row_id = dplyr::row_number(),
      .before = 1
    ) 
  f = chord_spectrum$x
  f0_row = frequency_results %>% dplyr::filter(paused_frequency == f[1])
  if (f0_row[[1]] == 1) { best_frequency = append(best_frequency, trial)}
  f0_frequency_scoreboard[f0_row[[1]]] = f0_frequency_scoreboard[f0_row[[1]]] + 1
  f1_row = frequency_results %>% dplyr::filter(paused_frequency == f[2])
  f1_frequency_scoreboard[f1_row[[1]]] = f1_frequency_scoreboard[f1_row[[1]]] + 1
  f2_row = frequency_results %>% dplyr::filter(paused_frequency == f[3])
  f2_frequency_scoreboard[f2_row[[1]]] = f2_frequency_scoreboard[f2_row[[1]]] + 1
  f3_row = frequency_results %>% dplyr::filter(paused_frequency == f[4])
  f3_frequency_scoreboard[f3_row[[1]]] = f3_frequency_scoreboard[f3_row[[1]]] + 1
  f4_row = frequency_results %>% dplyr::filter(paused_frequency == f[5])
  f4_frequency_scoreboard[f4_row[[1]]] = f4_frequency_scoreboard[f4_row[[1]]] + 1

  period_scores = looped_paused %>% dplyr::rowwise() %>% dplyr::mutate(
    paused_frequency = metadata$paused_frequency,
    distance         = noisy_chord$period_consonance-period_consonance
  )
  
  period_results = period_scores %>%
    dplyr::arrange(
      dplyr::desc(distance),
      paused_frequency
    )  %>%
    dplyr::ungroup() %>% 
    dplyr::mutate(
      row_id = dplyr::row_number(),
      .before = 1
    ) 
  f = chord_spectrum$x
  f0_row = period_results %>% dplyr::filter(paused_frequency == f[1])
  if (f0_row[[1]] == 1) {best_period = append(best_period, trial)}
  f0_period_scoreboard[f0_row[[1]]] = f0_period_scoreboard[f0_row[[1]]] + 1
  f1_row = period_results %>% dplyr::filter(paused_frequency == f[2])
  f1_period_scoreboard[f1_row[[1]]] = f1_period_scoreboard[f1_row[[1]]] + 1
  f2_row = period_results %>% dplyr::filter(paused_frequency == f[3])
  f2_period_scoreboard[f2_row[[1]]] = f2_period_scoreboard[f2_row[[1]]] + 1
  f3_row = period_results %>% dplyr::filter(paused_frequency == f[4])
  f3_period_scoreboard[f3_row[[1]]] = f3_period_scoreboard[f3_row[[1]]] + 1
  f4_row = period_results %>% dplyr::filter(paused_frequency == f[5])
  f4_period_scoreboard[f4_row[[1]]] = f4_period_scoreboard[f4_row[[1]]] + 1

  spatiofrequency_scores = looped_paused %>% dplyr::rowwise() %>% dplyr::mutate(
    paused_frequency = metadata$paused_frequency,
    distance         = noisy_chord$consonance_dissonance-consonance_dissonance
  )
  
  spatiofrequency_results = spatiofrequency_scores %>%
    dplyr::arrange(
      dplyr::desc(distance),
      paused_frequency
    )  %>%
    dplyr::ungroup() %>% 
    dplyr::mutate(
      row_id = dplyr::row_number(),
      .before = 1
    ) 
  f = chord_spectrum$x
  f0_row = spatiofrequency_results %>% dplyr::filter(paused_frequency == f[1])
  if (f0_row[[1]] == 1) {best_spatiofrequency = append(best_spatiofrequency, trial)}
  f0_spatiofrequency_scoreboard[f0_row[[1]]] = f0_spatiofrequency_scoreboard[f0_row[[1]]] + 1
  f1_row = spatiofrequency_results %>% dplyr::filter(paused_frequency == f[2])
  f1_spatiofrequency_scoreboard[f1_row[[1]]] = f1_spatiofrequency_scoreboard[f1_row[[1]]] + 1
  f2_row = spatiofrequency_results %>% dplyr::filter(paused_frequency == f[3])
  f2_spatiofrequency_scoreboard[f2_row[[1]]] = f2_spatiofrequency_scoreboard[f2_row[[1]]] + 1
  f3_row = spatiofrequency_results %>% dplyr::filter(paused_frequency == f[4])
  f3_spatiofrequency_scoreboard[f3_row[[1]]] = f3_spatiofrequency_scoreboard[f3_row[[1]]] + 1
  f4_row = spatiofrequency_results %>% dplyr::filter(paused_frequency == f[5])
  f4_spatiofrequency_scoreboard[f4_row[[1]]] = f4_spatiofrequency_scoreboard[f4_row[[1]]] + 1

}
```
# Temporal
### f0: `r f0_frequency_scoreboard`
### f1: `r f1_frequency_scoreboard`
### f2: `r f2_frequency_scoreboard`
### f3: `r f3_frequency_scoreboard`
### f4: `r f4_frequency_scoreboard`
### best_frequency: `r best_frequency`

# Spatial
### f0: `r f0_period_scoreboard`
### f1: `r f1_period_scoreboard`
### f2: `r f2_period_scoreboard`
### f3: `r f3_period_scoreboard`
### f4: `r f4_period_scoreboard`
### best_period: `r best_period`

# Spatiofrequency
### f0: `r f0_spatiofrequency_scoreboard`
### f1: `r f1_spatiofrequency_scoreboard`
### f2: `r f2_spatiofrequency_scoreboard`
### f3: `r f3_spatiofrequency_scoreboard`
### f4: `r f4_spatiofrequency_scoreboard`
### best_spatiofrequency: `r best_spatiofrequency`

##### Number of Unique Trials `r c(best_frequency,best_period,best_spatiofrequency) %>% unique() %>% length()`
